'use client';

import React, { useState, useEffect } from 'react';
import { Question } from '@istqb-app/shared';
import { Card } from './Card';
import { Button } from './Button';
import { useTranslation } from '@/lib/useTranslation';

interface QuestionCardProps {
  question: Question;
  onAnswer: (selectedOptions: string[], timeSpent: number) => void;
  isLoading?: boolean;
  showFeedback?: boolean;
  isCorrect?: boolean;
  selectedAnswerIds?: string[]; // IDs de las opciones seleccionadas para mostrar su explicaciÃ³n
}

export const QuestionCard: React.FC<QuestionCardProps> = ({
  question,
  onAnswer,
  isLoading = false,
  showFeedback = false,
  isCorrect = false,
  selectedAnswerIds = [],
}) => {
  const { t } = useTranslation();
  const [selectedOptions, setSelectedOptions] = useState<string[]>([]);
  const [answered, setAnswered] = useState(false);

  const handleSelectOption = (optionId: string) => {
    if (question.type === 'true_false' || question.type === 'multiple_choice') {
      // Para preguntas con una sola respuesta correcta, reemplazar selecciÃ³n
      if (question.type === 'true_false') {
        setSelectedOptions([optionId]);
      } else {
        // Para opciÃ³n mÃºltiple, permitir mÃºltiples selecciones si es requerido
        setSelectedOptions((prev) =>
          prev.includes(optionId)
            ? prev.filter((id) => id !== optionId)
            : [...prev, optionId]
        );
      }
    }
  };

  const handleSubmit = () => {
    if (selectedOptions.length > 0 && !answered) {
      setAnswered(true);
      onAnswer(selectedOptions);
    }
  };

  return (
    <Card className="w-full">
      {/* Header */}
      <div className="flex justify-between items-center mb-6 pb-4 border-b">
        <span className="text-sm font-semibold text-gray-600 dark:text-gray-400">
          {t('study.difficulty')}: <span className="capitalize">{question.difficultyLabel || 'N/A'}</span>
        </span>
      </div>

      {/* Pregunta */}
      <h2 className="text-2xl font-bold mb-6">{question.title}</h2>
      {question.description && (
        <p className="text-gray-700 dark:text-gray-300 mb-6">{question.description}</p>
      )}

      {/* Opciones */}
      <div className="space-y-3 mb-8">
        {Array.isArray(question.options) &&
          question.options.map((option: any) => (
            <label
              key={option.id}
              className={`flex items-center p-4 border rounded-lg cursor-pointer transition ${
                selectedOptions.includes(option.id)
                  ? 'bg-blue-100 border-blue-500 dark:bg-blue-900 dark:border-blue-400'
                  : 'bg-gray-50 border-gray-300 dark:bg-gray-800 dark:border-gray-600'
              } ${answered ? 'opacity-70 cursor-not-allowed' : ''}`}
            >
              <input
                type={question.type === 'true_false' ? 'radio' : 'checkbox'}
                name={`question-${question.id}`}
                value={option.id}
                checked={selectedOptions.includes(option.id)}
                onChange={() => handleSelectOption(option.id)}
                disabled={answered}
                className="w-5 h-5"
              />
              <span className="ml-3 text-gray-800 dark:text-gray-200">{option.text}</span>
            </label>
          ))}
      </div>

      {/* Feedback */}
      {showFeedback && answered && (
        <div
          className={`mb-6 p-4 rounded-lg ${
            isCorrect
              ? 'bg-green-100 border border-green-500 dark:bg-green-900 dark:border-green-400'
              : 'bg-red-100 border border-red-500 dark:bg-red-900 dark:border-red-400'
          }`}
        >
          <h3 className="font-bold mb-2">
            {isCorrect ? 'âœ… ' + t('study.correct') : 'âŒ ' + t('study.incorrect')}
          </h3>
          {/* Mostrar explicaciÃ³n de cada opciÃ³n seleccionada */}
          {selectedAnswerIds && selectedAnswerIds.length > 0 && (
            <div className="space-y-2">
              {selectedAnswerIds.map((optionId) => {
                const option = question.options.find((opt) => opt.id === optionId);
                if (option?.explanation) {
                  return (
                    <div key={optionId} className="text-sm text-gray-800 dark:text-gray-200">
                      <span className="font-semibold">OpciÃ³n {optionId.toUpperCase()}:</span> {option.explanation}
                    </div>
                  );
                }
                return null;
              })}
            </div>
          )}
        </div>
      )}

      {/* BotÃ³n de envÃ­o */
      {!answered && (
        <Button
          variant="primary"
          size="lg"
          className="w-full"
          disabled={selectedOptions.length === 0 || isLoading}
          onClick={handleSubmit}
        >
          {isLoading ? t('study.evaluating') : t('study.submitAnswer')}
        </Button>
      )}
    </Card>
  );
};

